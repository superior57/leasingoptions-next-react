{"ast":null,"code":"import { Fragment as _Fragment } from \"react/jsx-runtime\";\nimport { jsxs as _jsxs } from \"react/jsx-runtime\";\nimport { jsx as _jsx } from \"react/jsx-runtime\";\nimport _defineProperty from \"E:/current_project/PPH/tfs/Website/website/node_modules/next/node_modules/@babel/runtime/helpers/esm/defineProperty\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nimport React, { useState, useEffect } from 'react';\nimport { useFormContext } from \"react-hook-form\";\nimport { useRouter } from 'next/router';\nimport GarageVehicleSelector from '../garage-item/garage-vehicle-selector';\nimport GarageVehicle from '../garage-item/garage-vehicle';\nimport _ from 'underscore';\nimport { LeasingDealTypes } from 'enums/LeasingDealTypes';\nimport { GarageViewModes } from 'enums/GarageViewModes';\nimport { isNullOrWhiteSpace } from 'helpers/stringHelper';\nimport { formatMoney, unformat } from 'helpers/currencyHelper';\nimport { getQueryParams, getUrl } from 'helpers/urlsHelper';\nimport { GetVehicleUrl } from 'helpers/urlHelper';\nimport { CustomOptionsHelper } from 'helpers/customOptionsHelper';\nimport { GarageStorageHelper } from '../_libs/helpers/garageStorageHelper';\nimport { GarageService } from 'business-logic/garageService';\nimport { GetVehicleGarage, GetVehiclePricesDetails } from 'business-logic/vehicleService';\n\n//TODO: consider integration with redux, keeping customOptions state on vehicle component level\nvar GarageManager = function GarageManager(_ref) {\n  var settings = _ref.settings;\n  var router = useRouter();\n\n  var _useFormContext = useFormContext(),\n      register = _useFormContext.register,\n      errors = _useFormContext.errors,\n      setValue = _useFormContext.setValue;\n\n  var pricesDefaultState = {\n    fullMonthlyPrice: \"Please Call\",\n    initialRental: \"POA\",\n    salesCode: \"POA\",\n    monthlyMaintenancePrice: \"POA\",\n    processingFee: \"POA\",\n    extraOptions: [],\n    extraOptionsTotal: formatMoney(0),\n    p11d: \"N/A\",\n    bikTax: \"-\"\n  };\n\n  var _useState = useState(GarageViewModes.Price),\n      viewMode = _useState[0],\n      setViewMode = _useState[1];\n\n  var _useState2 = useState(true),\n      isCloneAllowed = _useState2[0],\n      setIsCloneAllowed = _useState2[1];\n\n  var _useState3 = useState([{\n    idx: 0,\n    id: \"\",\n    vehicle: null,\n    loadDataTimerId: null\n  }, {\n    idx: 1,\n    id: \"\",\n    vehicle: null,\n    loadDataTimerId: null\n  }, {\n    idx: 2,\n    id: \"\",\n    vehicle: null,\n    loadDataTimerId: null\n  }, {\n    idx: 3,\n    id: \"\",\n    vehicle: null,\n    loadDataTimerId: null\n  }]),\n      items = _useState3[0],\n      setItems = _useState3[1];\n\n  useEffect(function () {\n    var parts = router.asPath.split('?');\n    var garageId = parts[1] ? getQueryParams(parts[1].split('&'))[\"load\"] : null;\n\n    if (garageId) {\n      GarageStorageHelper.clear();\n      GarageService.GetGarage(garageId).then(function (result) {\n        if (result.isSucceed && result.data) {\n          var data = result.data;\n\n          for (var i = 0; i < data.length; i++) {\n            var item = data[i];\n\n            if (item) {\n              GarageStorageHelper.addItem(item.index, item.customOptions);\n            }\n          }\n        }\n\n        initGarageVehicles();\n      });\n    } else {\n      initGarageVehicles();\n    }\n  }, []);\n  useEffect(function () {\n    if (settings.onStateChanged) {\n      settings.onStateChanged(items);\n    }\n  }, [items]);\n\n  var initGarageVehicles = function initGarageVehicles() {\n    var storageItems = GarageStorageHelper.getItems(false);\n\n    if (storageItems) {\n      for (var idx = 0; idx < storageItems.length; idx++) {\n        var storageItem = storageItems[idx];\n        showGarageItemVehicle(storageItem);\n      }\n    }\n  };\n\n  var getPrices = function getPrices(leasingDealType, originalPrices) {\n    var prices = _.clone(pricesDefaultState);\n\n    prices.processingFee = formatMoney(parseFloat(leasingDealType === LeasingDealTypes.Personal ? process.env.NEXT_PUBLIC_PCH_PROC_FEE : process.env.NEXT_PUBLIC_CH_PROC_FEE));\n\n    if (originalPrices) {\n      var hasAllowedPrice = originalPrices.baseMonthlyPrice && originalPrices.baseMonthlyPrice > 0;\n      prices.extraOptions = originalPrices.extraOptions || [];\n      prices.extraOptionsTotal = formatMoney(originalPrices.extraOptionsTotal);\n      prices.p11d = originalPrices.p11D ? formatMoney(originalPrices.p11D) : \"N/A\";\n      prices.bikTax = originalPrices.bik20Tax && originalPrices.bik40Tax ? formatMoney(originalPrices.bik20Tax) + \"/\" + formatMoney(originalPrices.bik40Tax) + \" p/m\" : \"-\";\n\n      if (hasAllowedPrice) {\n        prices.fullMonthlyPrice = originalPrices.fullMonthlyPrice ? formatMoney(originalPrices.fullMonthlyPrice) : \"Please Call\";\n        prices.initialRental = formatMoney(originalPrices.initialRental);\n        prices.salesCode = formatMoney(originalPrices.salesCode);\n        prices.monthlyPrice = formatMoney(originalPrices.baseMonthlyPrice);\n        prices.monthlyMaintenancePrice = formatMoney(originalPrices.monthlyMaintenancePrice);\n      }\n    }\n\n    return prices;\n  };\n\n  var setGarageItemVehicle = function setGarageItemVehicle(idx, itemId, vehicleData) {\n    var garageItem = items[idx];\n\n    if (garageItem) {\n      setItems(function (prevState) {\n        var newItems = prevState.map(function (item, itemIdx) {\n          if (item && itemIdx === idx && item.idx === idx) {\n            var prices = getPrices(vehicleData.customOptions.leasingDealType, vehicleData.prices);\n\n            var updatedItem = _objectSpread(_objectSpread({}, item), {}, {\n              id: itemId,\n              vehicle: {\n                baseDetails: vehicleData.baseDetails,\n                customOptions: vehicleData.customOptions,\n                prices: prices,\n                vehicleOptions: {\n                  specifications: vehicleData.specifications.map(function (category) {\n                    return {\n                      name: category.name,\n                      options: category.options.map(function (option) {\n                        return {\n                          name: option\n                        };\n                      })\n                    };\n                  }),\n                  technicals: vehicleData.technicals,\n                  extras: vehicleData.extras\n                },\n                availableMileages: vehicleData.availableMileages\n              }\n            });\n\n            return updatedItem;\n          }\n\n          return item;\n        });\n        return newItems;\n      });\n      setIsCloneAllowed(!GarageStorageHelper.isFull());\n    }\n  };\n\n  var showGarageItemVehicle = function showGarageItemVehicle(initData) {\n    if (initData) {\n      var vehicle = initData.vehicle;\n      var vehicleRef = vehicle.vehicleRef;\n      var leasingDealType = vehicle.leasingDealType;\n      var customOptions = {\n        term: vehicle.term,\n        mileage: vehicle.mileage,\n        maintenance: vehicle.maintenance,\n        initialRentalMonths: vehicle.initialRentalMonths,\n        options: vehicle.options,\n        salesCode: vehicle.salesCode,\n        ageCategory: vehicle.ageCategory\n      };\n      GetVehicleGarage(vehicleRef, leasingDealType, customOptions).then(function (result) {\n        if (result.isSucceed && result.data) {\n          var data = result.data;\n          GarageStorageHelper.updateItem(initData.id, data.customOptions, false); //TODO: should we fix options mutations? Might heppen for on internal page for public user (salescode value). Other cases?\n\n          setGarageItemVehicle(initData.index, initData.id, data);\n        } else {\n          GarageStorageHelper.removeItem(initData.id);\n        }\n      });\n    }\n  };\n\n  var onAdd = function onAdd(idx, item) {\n    if (item) {\n      var vehicleRef = item.vehicleRef;\n      var leasingDealType = item.leasingDealType;\n      GetVehicleGarage(vehicleRef, leasingDealType, null).then(function (result) {\n        if (result.isSucceed && result.data) {\n          var data = result.data;\n          var storageItem = GarageStorageHelper.addItem(idx, data.customOptions);\n\n          if (storageItem) {\n            setGarageItemVehicle(storageItem.index, storageItem.id, data);\n          }\n        }\n      });\n    }\n  };\n\n  var onClone = function onClone(idx) {\n    var garageItem = items[idx];\n\n    if (garageItem && !isNullOrWhiteSpace(garageItem.id) && isCloneAllowed) {\n      var itemId = garageItem.id;\n      var storageItem = GarageStorageHelper.cloneItem(itemId);\n      showGarageItemVehicle(storageItem);\n    }\n  };\n\n  var onRefresh = function onRefresh(idx, id, customOptions) {\n    if (customOptions && !isNullOrWhiteSpace(id)) {\n      var storageItem = GarageStorageHelper.updateItem(id, customOptions, false);\n\n      if (storageItem && storageItem.index === idx) {\n        var sourceGarageItem = items[idx];\n\n        if (sourceGarageItem) {\n          if (sourceGarageItem.loadDataTimerId) {\n            clearTimeout(sourceGarageItem.loadDataTimerId);\n          }\n\n          sourceGarageItem.loadDataTimerId = setTimeout(function () {\n            GetVehiclePricesDetails({\n              pricingType: undefined,\n              postcode: undefined,\n              vehicleRef: storageItem.vehicle.vehicleRef,\n              leasingDealType: storageItem.vehicle.leasingDealType,\n              term: storageItem.vehicle.term,\n              mileage: storageItem.vehicle.mileage,\n              maintenance: storageItem.vehicle.maintenance,\n              initialRentalMonths: storageItem.vehicle.initialRentalMonths,\n              options: storageItem.vehicle.options,\n              salesCode: storageItem.vehicle.salesCode,\n              ageCategory: storageItem.vehicle.ageCategory\n            }).then(function (result) {\n              var data = null;\n\n              if (result.isSucceed && result.data) {\n                data = result.data;\n              }\n\n              setItems(function (prevState) {\n                var newItems = prevState.map(function (item, itemIdx) {\n                  if (item && itemIdx === idx && item.idx === idx && item.id === id) {\n                    var prices = getPrices(customOptions.leasingDealType, data);\n\n                    var updatedItem = _objectSpread(_objectSpread({}, item), {}, {\n                      vehicle: _objectSpread(_objectSpread({}, item.vehicle), {}, {\n                        customOptions: customOptions,\n                        prices: prices\n                      })\n                    });\n\n                    return updatedItem;\n                  }\n\n                  return item;\n                });\n                return newItems;\n              });\n            });\n          }, 200);\n        }\n      }\n    }\n  };\n\n  var onRemove = function onRemove(idx) {\n    var garageItem = items[idx];\n\n    if (garageItem && !isNullOrWhiteSpace(garageItem.id)) {\n      var itemId = garageItem.id;\n\n      if (GarageStorageHelper.removeItem(itemId)) {\n        setItems(function (prevState) {\n          var newItems = prevState.map(function (item, itemIdx) {\n            if (item && itemIdx === idx && item.idx === idx && item.id === itemId) {\n              var updatedItem = _objectSpread(_objectSpread({}, item), {}, {\n                id: \"\",\n                vehicle: null\n              });\n\n              return updatedItem;\n            }\n\n            return item;\n          });\n          return newItems;\n        });\n        setIsCloneAllowed(!GarageStorageHelper.isFull());\n      }\n    }\n  };\n\n  var onEnquire = function onEnquire(idx) {\n    //TODO: add check if enquiry is allowed? Hide enquiry button if not\n    var garageItem = items[idx];\n\n    if (garageItem && garageItem.vehicle) {\n      var vehicleData = garageItem.vehicle.baseDetails;\n      var customOptions = garageItem.vehicle.customOptions;\n      CustomOptionsHelper.storeVehicleCustomOptions(customOptions);\n      var url = getUrl(GetVehicleUrl(false, null, customOptions.leasingDealType, vehicleData.manufacturer, vehicleData.shortModel, vehicleData.model, vehicleData.derivative, customOptions.vehicleRef), [\"showordermodal=1\"]);\n      router.push(url);\n    }\n  };\n\n  var handlePriceInput = function handlePriceInput(evt) {\n    var name = evt.target.name;\n    var value = evt.target.value;\n    setValue(name, value ? formatMoney(unformat(value)) : null);\n  };\n\n  return /*#__PURE__*/_jsxs(\"div\", {\n    children: [/*#__PURE__*/_jsx(\"div\", {\n      className: \"row\",\n      children: /*#__PURE__*/_jsxs(\"div\", {\n        className: \"col-24\",\n        children: [/*#__PURE__*/_jsx(\"div\", {\n          className: \"w-100 bg-blue text-white text-center h2 mb-0 py-3\",\n          children: \"Compare by\"\n        }), /*#__PURE__*/_jsxs(\"div\", {\n          className: \"w-100 bg-light-grey p-3 d-md-flex flex-md-nowrap\",\n          children: [/*#__PURE__*/_jsx(\"button\", {\n            className: \"w-100 d-block d-md-inline-flex justify-content-center btn btn-fluid h3 py-3 py-md-2 mb-0 text-dark-grey \".concat(viewMode === GarageViewModes.Price ? \"is-active\" : \"\"),\n            onClick: function onClick() {\n              return setViewMode(GarageViewModes.Price);\n            },\n            children: \"Price\"\n          }), /*#__PURE__*/_jsx(\"button\", {\n            className: \"w-100 d-block d-md-inline-flex justify-content-center btn btn-fluid h3 py-3 py-md-2 mb-0 text-dark-grey \".concat(viewMode === GarageViewModes.Specification ? \"is-active\" : \"\"),\n            onClick: function onClick() {\n              return setViewMode(GarageViewModes.Specification);\n            },\n            children: \"Specification\"\n          }), /*#__PURE__*/_jsx(\"button\", {\n            className: \"w-100 d-block d-md-inline-flex justify-content-center btn btn-fluid h3 py-3 py-md-2 mb-0 text-dark-grey \".concat(viewMode === GarageViewModes.Technical ? \"is-active\" : \"\"),\n            onClick: function onClick() {\n              return setViewMode(GarageViewModes.Technical);\n            },\n            children: \"Technical\"\n          }), /*#__PURE__*/_jsx(\"button\", {\n            className: \"w-100 d-block d-md-inline-flex justify-content-center btn btn-fluid h3 py-3 py-md-2 mb-0 text-dark-grey \".concat(viewMode === GarageViewModes.Extras ? \"is-active\" : \"\"),\n            onClick: function onClick() {\n              return setViewMode(GarageViewModes.Extras);\n            },\n            children: \"Add Optional Exras\"\n          })]\n        })]\n      })\n    }), settings.isInternal ? /*#__PURE__*/_jsxs(_Fragment, {\n      children: [/*#__PURE__*/_jsxs(\"div\", {\n        className: \"row my-3\",\n        children: [/*#__PURE__*/_jsx(\"div\", {\n          className: \"col-24\",\n          children: /*#__PURE__*/_jsx(\"strong\", {\n            children: \"Not Maintained Processing Fee\"\n          })\n        }), /*#__PURE__*/_jsxs(\"div\", {\n          className: \"col-sm-8 form-group\",\n          children: [\"Personal\", /*#__PURE__*/_jsx(\"br\", {}), /*#__PURE__*/_jsx(\"input\", {\n            type: \"text\",\n            className: \"form-control\",\n            name: \"fees.notMaintained.personal\",\n            onBlur: handlePriceInput,\n            ref: register\n          })]\n        }), /*#__PURE__*/_jsxs(\"div\", {\n          className: \"col-sm-8 form-group\",\n          children: [\"Business\", /*#__PURE__*/_jsx(\"br\", {}), /*#__PURE__*/_jsx(\"input\", {\n            type: \"text\",\n            className: \"form-control\",\n            name: \"fees.notMaintained.business\",\n            onBlur: handlePriceInput,\n            ref: register\n          })]\n        }), /*#__PURE__*/_jsxs(\"div\", {\n          className: \"col-sm-8 form-group\",\n          children: [\"Van\", /*#__PURE__*/_jsx(\"br\", {}), /*#__PURE__*/_jsx(\"input\", {\n            type: \"text\",\n            className: \"form-control\",\n            name: \"fees.notMaintained.van\",\n            onBlur: handlePriceInput,\n            ref: register\n          })]\n        })]\n      }), /*#__PURE__*/_jsxs(\"div\", {\n        className: \"row my-3\",\n        children: [/*#__PURE__*/_jsx(\"div\", {\n          className: \"col-24\",\n          children: /*#__PURE__*/_jsx(\"strong\", {\n            children: \"Maintained Processing Fee\"\n          })\n        }), /*#__PURE__*/_jsxs(\"div\", {\n          className: \"col-sm-8 form-group\",\n          children: [\"Personal\", /*#__PURE__*/_jsx(\"br\", {}), /*#__PURE__*/_jsx(\"input\", {\n            type: \"text\",\n            className: \"form-control\",\n            name: \"fees.maintained.personal\",\n            onBlur: handlePriceInput,\n            ref: register\n          })]\n        }), /*#__PURE__*/_jsxs(\"div\", {\n          className: \"col-sm-8 form-group\",\n          children: [\"Business\", /*#__PURE__*/_jsx(\"br\", {}), /*#__PURE__*/_jsx(\"input\", {\n            type: \"text\",\n            className: \"form-control\",\n            name: \"fees.maintained.business\",\n            onBlur: handlePriceInput,\n            ref: register\n          })]\n        }), /*#__PURE__*/_jsxs(\"div\", {\n          className: \"col-sm-8 form-group\",\n          children: [\"Van\", /*#__PURE__*/_jsx(\"br\", {}), /*#__PURE__*/_jsx(\"input\", {\n            type: \"text\",\n            className: \"form-control\",\n            name: \"fees.maintained.van\",\n            onBlur: handlePriceInput,\n            ref: register\n          })]\n        })]\n      })]\n    }) : null, /*#__PURE__*/_jsx(\"div\", {\n      className: \"row my-3 my-md-5\",\n      children: items.map(function (item) {\n        return /*#__PURE__*/_jsx(\"div\", {\n          className: \"col-24 col-md-12 col-lg-6 mb-3 mb-lg-0\",\n          children: item.vehicle ? /*#__PURE__*/_jsx(GarageVehicle, {\n            idx: item.idx,\n            id: item.id,\n            baseDetails: item.vehicle.baseDetails,\n            customOptions: item.vehicle.customOptions,\n            prices: item.vehicle.prices,\n            vehicleOptions: item.vehicle.vehicleOptions,\n            settings: {\n              isInternal: settings.isInternal,\n              useBlackFridayTheme: process.env.NEXT_PUBLIC_BLACK_FRIDAY_THEME === 'true',\n              viewMode: viewMode,\n              isCloneAllowed: isCloneAllowed,\n              availableMileages: item.vehicle.availableMileages,\n              onRefresh: onRefresh,\n              onClone: onClone,\n              onRemove: onRemove,\n              onEnquire: onEnquire\n            }\n          }) : /*#__PURE__*/_jsx(GarageVehicleSelector, {\n            idx: item.idx,\n            settings: {\n              onSelect: onAdd\n            }\n          })\n        }, item.idx);\n      })\n    })]\n  });\n};\n\nexport default GarageManager;","map":null,"metadata":{},"sourceType":"module"}